{% extends 'base.html' %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-2">
  <div>
    <h1 class="h3 mb-1">{{ file_row.file_no }}</h1>
    <p class="text-muted mb-0">{{ file_row.customer_code }} / {{ file_row.customer_name }}{% if file_row.po_no %} Â· {{ file_row.po_no }}{% endif %}</p>
  </div>
  <div class="text-end small text-muted">
    <div>Order Date: {{ file_row.order_date }}</div>
    <div>Due Date: {{ file_row.due_date or '-' }}</div>
    <div>Total Ordered: {{ total_qty }} KG</div>
  </div>
</div>

<div class="row g-4">
  <div class="col-xl-4">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Add Product Line</strong></div>
      <div class="card-body">
        <form method="post">
          <div class="mb-3"><label class="form-label">Product</label>
            <select class="form-select" name="product_id" required>
              <option value="">Select product</option>
              {% for row in products %}<option value="{{ row.id }}">{{ row.sku }} / {{ row.name }}</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Ordered Qty KG</label><input class="form-control" type="number" step="0.01" name="ordered_qty_kg" required></div>
          <div class="mb-3"><label class="form-label">Preferred Line</label>
            <select class="form-select" name="target_line_id">
              <option value="">No preferred line</option>
              {% for row in lines %}<option value="{{ row.id }}">{{ row.code }} / {{ row.name }}</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Remarks</label><textarea class="form-control" name="remarks" rows="3" placeholder="e.g. urgent, special recipe, split line"></textarea></div>
          <button class="btn btn-dark w-100">Add Line</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
        <strong>Item-by-item status trace</strong>
        <div class="d-flex gap-2">
          <a class="btn btn-sm btn-outline-dark" href="{{ url_for('item_tracker') }}">Open item tracker</a>
          <a class="btn btn-sm btn-dark" href="{{ url_for('jobs') }}">Create jobs</a>
        </div>
      </div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead>
            <tr>
              <th>Line</th>
              <th>Product</th>
              <th>Qty KG</th>
              <th>Preferred Line</th>
              <th>Job</th>
              <th>Current</th>
              <th>Stage</th>
              <th>Planner Ready</th>
              <th>Remain Hrs</th>
              <th>Risk</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for row in items %}
            <tr>
              <td>{{ row.line_no }}</td>
              <td>
                <div class="fw-semibold">{{ row.sku }} / {{ row.product_name }}</div>
                <div class="small text-muted">{{ row.remarks or '-' }}</div>
              </td>
              <td>{{ row.ordered_qty_kg }}</td>
              <td>{% if row.line_code %}{{ row.line_code }} / {{ row.line_name }}{% else %}-{% endif %}</td>
              <td>{{ row.job_no or '-' }}</td>
              <td>
                <span class="badge text-bg-{% if row.tracking_status == 'COMPLETED' %}success{% elif row.tracking_status == 'IN_PRODUCTION' %}primary{% elif row.tracking_status == 'HOLD' %}danger{% elif row.tracking_status == 'READY_FOR_PRODUCTION' %}warning{% else %}secondary{% endif %}">
                  {{ row.tracking_status or row.status }}
                </span>
              </td>
              <td>{{ row.tracking_stage or '-' }}</td>
              <td>{{ row.tracking_ready_at or '-' }}</td>
              <td>{{ row.tracking_remaining_hours if row.tracking_remaining_hours is not none else '-' }}</td>
              <td>
                <span class="badge text-bg-{% if row.tracking_risk == 'RISK' %}danger{% elif row.tracking_risk == 'TIGHT' %}warning{% else %}secondary{% endif %}">
                  {{ row.tracking_risk or 'CHECK' }}
                </span>
              </td>
              <td><a class="btn btn-sm btn-outline-dark" href="{{ url_for('item_tracker_detail', item_id=row.id) }}">Trace</a></td>
            </tr>
            {% else %}
            <tr><td colspan="11" class="text-center text-muted">No product lines yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}
