{% extends 'base.html' %}
{% block content %}
<h1 class="h3 mb-4">Loss / Machine / OT Reports</h1>
<div class="card shadow-sm mb-4">
  <div class="card-header bg-white"><strong>Batch Variance Report</strong></div>
  <div class="card-body table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead>
        <tr>
          <th>Batch</th><th>Job</th><th>Customer</th><th>Product</th><th>Line</th><th>Current Process</th><th>Input KG</th><th>Good Output KG</th><th>Total Reject KG</th><th>Variance KG</th><th>Variance %</th><th>Likely Loss Process</th>
        </tr>
      </thead>
      <tbody>
        {% for row in variance_rows %}
        <tr>
          <td>{{ row.batch_no }}</td>
          <td>{{ row.job_no }}</td>
          <td>{{ row.customer_name }}</td>
          <td>{{ row.product_name }}</td>
          <td>{{ row.line_name or '-' }}</td>
          <td>{{ row.current_process }}</td>
          <td>{{ row.input_qty_kg }}</td>
          <td>{{ row.good_output_kg }}</td>
          <td>{{ row.total_reject_kg }}</td>
          <td>{{ row.variance_kg if row.variance_kg is not none else '-' }}</td>
          <td>{{ row.variance_pct ~ '%' if row.variance_pct is not none else '-' }}</td>
          <td>{{ row.probable_loss_process or '-' }}</td>
        </tr>
        {% else %}
        <tr><td colspan="12" class="text-center text-muted">No batch variance data yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="row g-4 mb-4">
  <div class="col-lg-7">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Loss by Process Stage</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead><tr><th>Process</th><th>Scans</th><th>Total Input</th><th>Total Good</th><th>Total Reject</th><th>Total Variance</th></tr></thead>
          <tbody>
            {% for row in process_stage_rows %}
            <tr>
              <td>{{ row.process_name }}</td>
              <td>{{ row.scans }}</td>
              <td>{{ row.total_input }}</td>
              <td>{{ row.total_good }}</td>
              <td>{{ row.total_reject }}</td>
              <td>{{ row.total_variance }}</td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center text-muted">No process data yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>OT by Section</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead><tr><th>Section</th><th>Entries</th><th>Employees</th><th>Total OT Hours</th></tr></thead>
          <tbody>
            {% for row in ot_rows %}
            <tr><td>{{ row.section_name }}</td><td>{{ row.entries }}</td><td>{{ row.total_employees }}</td><td>{{ row.total_ot_hours }}</td></tr>
            {% else %}
            <tr><td colspan="4" class="text-center text-muted">No OT records yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header bg-white"><strong>Machine Performance Snapshot</strong></div>
  <div class="card-body table-responsive">
    <table class="table table-striped table-sm align-middle">
      <thead><tr><th>Machine</th><th>Section</th><th>Line</th><th>Status</th><th>Scans</th><th>Total Good KG</th><th>Total Reject KG</th></tr></thead>
      <tbody>
        {% for row in machine_rows %}
        <tr>
          <td>{{ row.machine_code }}<div class="small text-muted">{{ row.machine_name }}</div></td>
          <td>{{ row.section_name }}</td>
          <td>{{ row.line_name or '-' }}</td>
          <td><span class="badge status-{{ row.status|lower }}">{{ row.status }}</span></td>
          <td>{{ row.scans }}</td>
          <td>{{ row.total_good_kg }}</td>
          <td>{{ row.total_reject_kg }}</td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="text-center text-muted">No machine data yet.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
