{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-5">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white"><strong>Lookup Batch / Barcode</strong></div>
      <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-9"><label class="form-label">Scan or type barcode</label><input class="form-control form-control-lg" name="barcode" value="{{ request.args.get('barcode', '') }}" placeholder="BAT-0001"></div>
          <div class="col-3"><button class="btn btn-dark w-100 btn-lg">Find</button></div>
        </form>
        {% if batch_lookup %}
        <div class="mt-4 p-3 bg-light rounded border">
          <div class="fw-semibold mb-1">{{ batch_lookup.batch_no }}</div>
          <div class="small text-muted">Job {{ batch_lookup.job_no }} / {{ batch_lookup.customer_name }} / {{ batch_lookup.product_name }}</div>
          <div class="small text-muted">Line {{ batch_lookup.line_name or '-' }} / Recipe {{ batch_lookup.recipe_code or '-' }}</div>
          <div class="mt-2">Current stage: <span class="badge text-bg-info">{{ batch_lookup.current_process }}</span></div>
          <div>Status: <span class="badge text-bg-secondary">{{ batch_lookup.status }}</span></div>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white"><strong>Record Process Scan + Issue Next Process Label</strong></div>
      <div class="card-body">
        <form method="post">
          <input type="hidden" name="action_type" value="process_scan">
          <div class="mb-3"><label class="form-label">Barcode / Batch</label><input class="form-control" name="barcode_text" value="{{ request.args.get('barcode', '') }}" required></div>
          <div class="mb-3"><label class="form-label">Process</label>
            <select class="form-select" name="process_name" id="process_name" required>
              <option value="">Select process</option>
              {% for p in processes %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Machine</label>
            <select class="form-select" name="machine_id" id="machine_id">
              <option value="">Select exact machine</option>
              {% for m in machines %}
              <option value="{{ m.id }}" data-process="{{ m.process_name }}">{{ m.machine_code }} / {{ m.machine_name }} / {{ m.line_name or '-' }} / {{ m.status }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3"><label class="form-label">Scan Time</label><input class="form-control" type="datetime-local" name="scan_time"></div>
          <div class="row g-2">
            <div class="col-md-4"><label class="form-label">Input KG</label><input class="form-control" type="number" step="0.01" name="input_qty_kg" required></div>
            <div class="col-md-4"><label class="form-label">Good KG</label><input class="form-control" type="number" step="0.01" name="good_qty_kg" required></div>
            <div class="col-md-4"><label class="form-label">Reject KG</label><input class="form-control" type="number" step="0.01" name="reject_qty_kg" value="0"></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-md-6"><label class="form-label">Operator</label><input class="form-control" name="operator_name"></div>
            <div class="col-md-6"><label class="form-label">Next Action</label>
              <select class="form-select" name="next_action">
                <option value="MOVE_NEXT">Move Next Process + Issue Label</option>
                <option value="REWORK">Rework</option>
                <option value="REJECTED">Rejected / Hold</option>
              </select>
            </div>
          </div>
          <div class="mt-3"><label class="form-label">Remarks</label><textarea class="form-control" name="remarks" rows="3"></textarea></div>
          <button class="btn btn-dark w-100 mt-3">Save Scan</button>
        </form>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Receive Next Process Barcode</strong></div>
      <div class="card-body">
        <form method="post">
          <input type="hidden" name="action_type" value="receive_next">
          <div class="mb-3"><label class="form-label">Next Process Barcode</label><input class="form-control" name="transfer_barcode" placeholder="NP-BAT-0001-CUT-FIN-..." required></div>
          <div class="row g-2">
            <div class="col-md-6"><label class="form-label">Receiving Process</label>
              <select class="form-select" name="receiving_process" required>
                <option value="">Select process</option>
                {% for p in processes %}<option value="{{ p }}">{{ p }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-6"><label class="form-label">Received KG</label><input class="form-control" type="number" step="0.01" name="received_qty_kg" required></div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-md-6"><label class="form-label">Receiver</label><input class="form-control" name="receiver_name"></div>
            <div class="col-md-6"><label class="form-label">Machine</label>
              <select class="form-select" name="receive_machine_id">
                <option value="">Optional machine</option>
                {% for m in machines %}
                <option value="{{ m.id }}">{{ m.machine_code }} / {{ m.machine_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-3"><label class="form-label">Notes</label><textarea class="form-control" name="receive_note" rows="2"></textarea></div>
          <button class="btn btn-outline-dark w-100 mt-3">Receive Barcode</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-7">
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white"><strong>Pending Next Process Labels (Awaiting Receive)</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead><tr><th>Barcode</th><th>Batch</th><th>Route</th><th>Issued KG</th><th>Recipe</th><th>Customer</th><th>Issued At</th></tr></thead>
          <tbody>
            {% for row in next_labels_pending %}
            <tr>
              <td><span class="small fw-semibold">{{ row.transfer_barcode }}</span></td>
              <td>{{ row.batch_no }}</td>
              <td>{{ row.from_process }} → {{ row.to_process }}</td>
              <td>{{ row.issued_qty_kg }}</td>
              <td>{{ row.recipe_code or '-' }}</td>
              <td>{{ row.customer_name }}</td>
              <td>{{ row.issued_at }}</td>
            </tr>
            {% else %}
            <tr><td colspan="7" class="text-center text-muted">No pending transfer labels.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white"><strong>Recent Scan History</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead><tr><th>Time</th><th>Batch</th><th>Process</th><th>Machine</th><th>Input</th><th>Good</th><th>Reject</th><th>Action</th></tr></thead>
          <tbody>
            {% for row in recent_logs %}
            <tr>
              <td>{{ row.scan_time }}</td>
              <td>{{ row.batch_no }}</td>
              <td>{{ row.process_name }}</td>
              <td>{{ row.machine_label or '-' }}</td>
              <td>{{ row.input_qty_kg }}</td>
              <td>{{ row.good_qty_kg }}</td>
              <td>{{ row.reject_qty_kg }}</td>
              <td>{{ row.next_action }}</td>
            </tr>
            {% else %}
            <tr><td colspan="8" class="text-center text-muted">No process scans yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header bg-white"><strong>Recent Next Process Transfers</strong></div>
      <div class="card-body table-responsive">
        <table class="table table-striped table-sm align-middle">
          <thead><tr><th>Barcode</th><th>Route</th><th>Issued KG</th><th>Received KG</th><th>Loss KG</th><th>Status</th></tr></thead>
          <tbody>
            {% for row in recent_transfers %}
            <tr>
              <td>{{ row.transfer_barcode }}</td>
              <td>{{ row.from_process }} → {{ row.to_process }}</td>
              <td>{{ row.issued_qty_kg }}</td>
              <td>{{ row.received_qty_kg if row.received_qty_kg is not none else '-' }}</td>
              <td>{{ row.qty_loss_kg }}</td>
              <td><span class="badge text-bg-{{ 'success' if row.status == 'RECEIVED' else 'warning' }}">{{ row.status }}</span></td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="text-center text-muted">No transfer labels yet.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const processSelect = document.getElementById('process_name');
  const machineSelect = document.getElementById('machine_id');
  if (processSelect && machineSelect) {
    const originalOptions = Array.from(machineSelect.options).map(option => ({
      value: option.value,
      text: option.text,
      process: option.dataset.process || ''
    }));

    function refreshMachines() {
      const process = processSelect.value;
      machineSelect.innerHTML = '';
      const first = document.createElement('option');
      first.value = '';
      first.textContent = 'Select exact machine';
      machineSelect.appendChild(first);
      originalOptions.forEach(item => {
        if (!item.value) return;
        if (!process || item.process === process) {
          const option = document.createElement('option');
          option.value = item.value;
          option.textContent = item.text;
          option.dataset.process = item.process;
          machineSelect.appendChild(option);
        }
      });
    }

    processSelect.addEventListener('change', refreshMachines);
    refreshMachines();
  }
</script>
{% endblock %}
